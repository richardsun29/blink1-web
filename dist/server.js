!function(e){var t={};function r(n){if(t[n])return t[n].exports;var u=t[n]={i:n,l:!1,exports:{}};return e[n].call(u.exports,u,u.exports,r),u.l=!0,u.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var u in e)r.d(n,u,function(t){return e[t]}.bind(null,u));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),n(r(7)).default.config();class u extends Error{constructor(e){super(e),this.name="ConfigNotSetError"}}t.default=class{static getRequiredConfig(e){if(process.env[e])return process.env[e];throw new u(e)}static getOptionalConfig(e,t){try{return this.getRequiredConfig(e)}catch(e){if("ConfigNotSetError"===e.name&&t)return t;throw e}}static get PUSHER_APPID(){return this.getRequiredConfig("PUSHER_APPID")}static get PUSHER_KEY(){return this.getRequiredConfig("PUSHER_KEY")}static get PUSHER_SECRET(){return this.getRequiredConfig("PUSHER_SECRET")}static get PUSHER_CLUSTER(){return this.getRequiredConfig("PUSHER_CLUSTER")}static get PUSHER_BLINK_CHANNEL(){return this.getOptionalConfig("PUSHER_CHANNEL","blink")}static get PORT(){return parseInt(this.getOptionalConfig("PORT","5000"))}static get PASSWORD_HASH(){return this.getRequiredConfig("PASSWORD_HASH")}static get JWT_SECRET(){return this.getRequiredConfig("JWT_SECRET")}static get BLINK_TIMEOUT(){return parseInt(this.getOptionalConfig("BLINK_TIMEOUT","30"))}}},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=n(r(9)),s=n(r(10)),i=n(r(11)),o=n(r(0)),a=n(r(12)),l=n(r(13));t.default=class{static createPusherClient(){return new i.default(o.default.PUSHER_KEY,{cluster:o.default.PUSHER_CLUSTER,encrypted:!0})}static createPusherServer(){return new s.default({appId:o.default.PUSHER_APPID,key:o.default.PUSHER_KEY,secret:o.default.PUSHER_SECRET,useTLS:!0,cluster:o.default.PUSHER_CLUSTER})}static createBlink1(){return new u.default}static createMessageReceiver(){return new a.default}static createMessageSender(){return new l.default}}},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=n(r(4)),s=n(r(1)),i=n(r(5)),o=n(r(6)),a=n(r(0)),l=n(r(8)),c=n(r(17)),f=s.default();f.use(i.default("dev")),f.use(s.default.json()),f.use(u.default()),f.use("/",c.default),f.use(s.default.static(o.default.join("dist","www"))),f.use("/api",l.default),f.listen(a.default.PORT,()=>console.log(`Listening on port ${a.default.PORT}`))},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("dotenv")},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(u,s){function i(e){try{a(n.next(e))}catch(e){s(e)}}function o(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){e.done?u(e.value):new r(function(t){t(e.value)}).then(i,o)}a((n=n.apply(e,t||[])).next())})},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=u(r(1)).default.Router(),i=u(r(2)),o=u(r(14)),a=r(15),l=(()=>{let e=null;return()=>(e||(e=i.default.createMessageSender()),e)})();s.post("/blink",(e,t,r)=>{a.isValidMessage(e.body)?(l().trigger("blink",e.body),t.send()):(t.status(400),t.send("Invalid message"))}),s.get("/status",(e,t,r)=>n(this,void 0,void 0,function*(){const e=yield Promise.race([l().isSubscriberConnected(),o.default(2e3,!1)]);t.send({isConnected:e})})),t.default=s},function(e,t){e.exports=require("node-blink1")},function(e,t){e.exports=require("pusher")},function(e,t){e.exports=require("pusher-js")},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=n(r(0)),s=n(r(2));t.default=class{constructor(){this.pusher=s.default.createPusherClient(),this.channel=this.pusher.subscribe(u.default.PUSHER_BLINK_CHANNEL),this.pusher.connection.bind("error",e=>{console.error("Pusher: connection error",e)})}bind(e,t){this.channel.bind(e,t)}disconnect(){this.pusher.disconnect()}}},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=n(r(0)),s=n(r(2));t.default=class{constructor(){this.pusherServer=s.default.createPusherServer()}trigger(e,t){this.pusherServer.trigger(u.default.PUSHER_BLINK_CHANNEL,e,t)}isSubscriberConnected(){return new Promise(e=>{this.pusherServer.get({path:`/channels/${u.default.PUSHER_BLINK_CHANNEL}`,params:{}},(t,r,n)=>{if(t)e(!1);else if(200===n.statusCode){const t=JSON.parse(n.body);e(t.occupied)}else e(!1)})})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return new Promise(r=>{setTimeout(()=>r(t),e)})}},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=n(r(16));var s;!function(e){e[e.BlinkOff=0]="BlinkOff",e[e.BlinkSetColor=1]="BlinkSetColor"}(s=t.MessageType||(t.MessageType={}));t.BlinkOffMessage=class{constructor(){this.type=s.BlinkOff}};t.BlinkSetColorMessage=class{constructor(e){this.type=s.BlinkSetColor,this.color=e}},t.isValidMessage=function(e){if(!u.default.isObjectLike(e))return!1;switch(e.type){case s.BlinkOff:return!0;case s.BlinkSetColor:return function(e){return!!u.default.isString(e)&&/^#[0-9a-f]{6}$/i.test(e)}(e.color);default:return!1}}},function(e,t){e.exports=require("lodash")},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=n(r(1)),s=u.default.Router(),i=n(r(18)),o=n(r(19)),a=n(r(0)),l='\n<!DOCTYPE html>\n<html>\n  <head>\n    <title>blink(1) web</title>\n  </head>\n  <body>\n    <h1>Login</h1>\n    <form method="POST">\n      <input name="password" type="password" placeholder="Password">\n      <button type="submit">Submit</button>\n    </form>\n  </body>\n</html>\n';s.post("/",u.default.urlencoded({extended:!0}),(e,t,r)=>{if(!e.body.password)return t.status(400),void t.send(l);i.default.compare(e.body.password,a.default.PASSWORD_HASH,(e,r)=>{if(r){const e=o.default.sign({},a.default.JWT_SECRET),r={maxAge:864e7};t.cookie("jwt",e,r),t.redirect("/")}else t.status(403),t.send(l)})}),s.all("*",(e,t,r)=>{const n=e.cookies.jwt;o.default.verify(n,a.default.JWT_SECRET,(e,n)=>{e?(t.status(403),t.send(l)):r()})}),t.default=s},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("jsonwebtoken")}]);
//# sourceMappingURL=server.js.map